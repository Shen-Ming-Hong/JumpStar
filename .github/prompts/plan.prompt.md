---
mode: agent
---

# 跳跳星 (JumpStar) 開發計畫

## 專案目標

開發一個基於 Arduino UNO 的互動式跳躍感測裝置，能夠即時偵測玩家跳躍動作，計算跳躍高度，並透過 WS2812B LED 燈條提供視覺化回饋。

## 階段一：環境設定與依賴配置

### 任務 1.1：配置 PlatformIO 環境

**要求**：

-   更新 `platformio.ini`，加入 FastLED 函式庫依賴
-   設定序列埠監控速率（建議 115200 baud）
-   確保使用 Git URL 方式安裝函式庫

**成功標準**：

-   `platformio.ini` 包含完整的函式庫依賴設定
-   專案能夠成功建置（使用者執行 `pio run`）

**約束條件**：

-   必須使用 GitHub URL 格式：`https://github.com/FastLED/FastLED.git#版本`
-   不使用 PlatformIO Registry

---

## 階段二：硬體腳位定義與基礎設定

### 任務 2.1：定義硬體常數

**要求**：

-   在 `src/main.cpp` 中定義紅外線感測器腳位
-   定義 WS2812B LED 燈條控制腳位
-   定義 LED 數量常數
-   使用 `const` 或 `#define` 宣告所有硬體相關常數

**成功標準**：

-   所有硬體腳位集中在檔案開頭定義
-   命名清晰且使用繁體中文註解
-   便於未來修改硬體配置

**建議配置**：

```cpp
// 紅外線感測器腳位（建議使用 D2 或 D3，支援外部中斷）
const int IR_SENSOR_PIN = 2;

// WS2812B LED 燈條設定（可使用任何數位腳位，避免 D0/D1 保留給序列埠）
const int LED_PIN = 6;
const int NUM_LEDS = 30;  // 根據實際燈條數量調整

// 序列埠速率
const long SERIAL_BAUD = 9600;
```

**硬體注意事項**：

-   **紅外線感測器**：建議使用 D2（支援外部中斷），也可用其他數位腳位
-   **WS2812B**：可用任何數位腳位，不需要 PWM 功能（FastLED 使用位元操作）
-   **電源**：如果 LED 數量超過 10 顆，建議使用外部 5V 電源供應
-   **保護元件**：
    -   LED 資料線建議加 330Ω 電阻降低雜訊
    -   電源端建議加 100µF 電容穩定電壓

---

## 階段三：紅外線感測器功能開發

### 任務 3.1：感測器初始化與基礎讀取

**要求**：

-   在 `setup()` 中初始化感測器腳位為 INPUT
-   在 `loop()` 中實作基礎感測器讀取
-   透過序列埠輸出感測器狀態（用於除錯）

**成功標準**：

-   能透過序列埠監控看到感測器即時狀態（HIGH/LOW）
-   感測器正確回應玩家在地面/離地狀態

**硬體連接檢查清單**：

-   ✅ IR 感測器 VCC → Arduino 5V
-   ✅ IR 感測器 GND → Arduino GND
-   ✅ IR 感測器 OUT → Arduino D2
-   ⚠️ 避免將感測器暴露在強光或直射陽光下
-   ⚠️ 調整感測器上的電位器設定偵測距離

### 任務 3.2：訊號去彈跳處理

**要求**：

-   實作軟體去彈跳邏輯，避免訊號雜訊造成誤觸發
-   使用時間閾值過濾短暫的訊號變化
-   考慮使用 Bounce2 函式庫或自行實作

**成功標準**：

-   感測器狀態變化穩定，無誤觸發
-   去彈跳時間設定合理（建議 50-100ms）

**約束條件**：

-   不可使用 `delay()`，必須使用 `millis()` 實作非阻塞式去彈跳

---

## 階段四：跳躍偵測與計時邏輯

### 任務 4.1：實作狀態機

**要求**：

-   定義跳躍狀態列舉：`GROUNDED`（在地面）、`IN_AIR`（空中）、`LANDING`（著地）
-   實作狀態轉換邏輯
-   在狀態轉換時觸發相應動作

**成功標準**：

-   狀態轉換邏輯清晰且正確
-   透過序列埠輸出可以追蹤狀態變化

**範例結構**：

```cpp
enum JumpState { GROUNDED, IN_AIR, LANDING };
JumpState currentState = GROUNDED;
```

### 任務 4.2：實作計時功能

**要求**：

-   在玩家離地時（`GROUNDED` → `IN_AIR`）記錄起始時間
-   在玩家著地時（`IN_AIR` → `LANDING`）計算離地時間
-   將離地時間（毫秒）轉換為跳躍高度估算值

**成功標準**：

-   能準確記錄離地時間
-   時間計算邏輯正確處理 `millis()` 溢位問題
-   透過序列埠輸出離地時間供驗證

**約束條件**：

-   使用 `unsigned long` 儲存時間戳
-   考慮 `millis()` 溢位處理（雖然實際使用不太會遇到）

---

## 階段五：WS2812B LED 燈條控制

### 任務 5.1：LED 燈條初始化

**要求**：

-   引入 FastLED 函式庫
-   在 `setup()` 中初始化 LED 燈條
-   實作基礎測試動畫（如開機彩虹效果）

**成功標準**：

-   LED 燈條能正常顯示顏色
-   開機時顯示測試動畫確認硬體正常

**範例程式碼**：

```cpp
#include <FastLED.h>

CRGB leds[NUM_LEDS];

void setup() {
    FastLED.addLeds<WS2812B, LED_PIN, GRB>(leds, NUM_LEDS);
    FastLED.setBrightness(50);  // 限制亮度避免電流過大（最大 255）
    FastLED.clear();  // 初始化時清空所有 LED
    FastLED.show();
}
```

**硬體連接檢查清單**：

-   ✅ LED 燈條 DIN → 330Ω 電阻 → Arduino D6
-   ✅ LED 燈條 5V → 外部電源 5V（如 LED 數量 > 10 顆）
-   ✅ LED 燈條 GND → Arduino GND 和外部電源 GND（共地）
-   ✅ 電源端加 100µF 電容（正極接 5V，負極接 GND）
-   ⚠️ Arduino USB 電源最多支援約 500mA，每顆 LED 最大約 60mA
-   ⚠️ 如使用外部電源，務必與 Arduino 共地

````

### 任務 5.2：設計燈效函式

**要求**：

-   實作依據跳躍高度顯示不同燈效的函式
-   定義至少 3 個高度等級（低、中、高）
-   每個等級對應不同的顏色或動畫效果

**成功標準**：

-   燈效清晰可辨，視覺效果良好
-   顏色選擇合理（例如：綠 → 黃 → 紅表示低 → 中 → 高）
-   燈效更新流暢，無明顯延遲

**約束條件**：

-   使用緩衝區模式，先設定所有 LED 再一次 `FastLED.show()`
-   考慮亮度限制（建議不超過 50% 避免電流過載）

---

## 階段六：高度與燈效映射算法

### 任務 6.1：建立映射關係

**要求**：

-   定義離地時間與跳躍高度的映射公式
-   將跳躍高度分級（建議 3-5 級）
-   實作分級判定函式

**成功標準**：

-   映射公式合理（可先使用線性映射，後續可調整）
-   分級閾值經過測試校準
-   不同高度能觸發對應的燈效

**建議映射方式**：

```cpp
// 範例：線性映射（需實測調整）
// 假設 < 300ms = 低, 300-500ms = 中, > 500ms = 高
int getJumpLevel(unsigned long airTime) {
    if (airTime < 300) return 1;
    else if (airTime < 500) return 2;
    else return 3;
}
````

### 任務 6.2：校準與測試

**要求**：

-   進行實際跳躍測試
-   調整時間閾值以符合真實跳躍表現
-   記錄測試數據並優化參數

**成功標準**：

-   不同力度的跳躍能正確分級
-   閾值設定符合一般使用者的跳躍能力
-   系統回饋即時且準確

---

## 階段七：整合與優化

### 任務 7.1：整合所有模組

**要求**：

-   將感測器、計時、狀態機、LED 控制整合到主程式
-   確保各模組協同工作正常
-   加入完整的繁體中文註解

**成功標準**：

-   完整的跳躍偵測與視覺回饋流程運作正常
-   程式碼結構清晰易讀
-   無明顯 bug 或異常行為

### 任務 7.2：效能優化

**要求**：

-   檢查 `loop()` 執行效率，確保無阻塞
-   優化 LED 更新頻率
-   減少不必要的計算和記憶體使用

**成功標準**：

-   `loop()` 循環時間短（建議 < 10ms）
-   LED 更新流暢無閃爍
-   感測器回應即時

---

## 階段八：進階功能（可選）

### 任務 8.1：遊戲模式設計

**要求**：

-   設計額外的互動模式（如：挑戰模式、計分系統）
-   實作模式切換機制
-   加入音效或更複雜的燈效

**成功標準**：

-   至少實作 1 個額外遊戲模式
-   模式切換流暢
-   使用者體驗良好

---

## 整體約束條件

1. **開發環境**：使用 PlatformIO + Arduino Framework
2. **函式庫管理**：一律使用 Git URL 方式安裝，不用 PlatformIO Registry
3. **程式風格**：支援繁體中文註解，使用 UTF-8 編碼
4. **非阻塞原則**：避免使用 `delay()`，改用 `millis()` 計時
5. **模組化設計**：功能分離，易於測試和維護
6. **硬體測試**：分階段測試，先驗證感測器再整合 LED

## 最終成功標準

-   ✅ 能準確偵測玩家跳躍動作
-   ✅ 正確計算離地時間並映射為跳躍高度
-   ✅ LED 燈條顯示對應的視覺回饋
-   ✅ 系統穩定運行，無誤觸發或當機
-   ✅ 程式碼結構清晰，文件完整
-   ✅ 透過序列埠可追蹤系統狀態（便於除錯）

## 開發順序建議

按照階段一到階段七依序開發，每個階段完成後進行測試驗證，確認無誤後再進入下一階段。階段八為進階功能，可視專案需求決定是否實作。
